name: Runtime - deploy kubernetes-wrapper
on:
  push:
    branches:
      - main
      # - feat/branch
    paths:
      - src/Runtime/kubernetes-wrapper/**
      - infra/studio/syncroot/base/kubernetes-wrapper.yaml
      - infra/runtime/syncroot/base/kubernetes-wrapper.yaml
      - .github/scripts/construct-environments.mjs
      - .github/workflows/deploy-kubernetes-wrapper.yaml
  workflow_dispatch:
    inputs:
      studio-environments:
        description: "Studio environments to tag. Comma-separated. Empty string skips studio tagging."
        required: false
        default: "dev"
      runtime-rings:
        description: "Runtime rings to tag. Comma-separated (e.g. at_ring1,at_ring2). Empty string skips runtime tagging."
        required: false
        default: "at_ring1"

permissions:
  contents: read
  packages: write

env:
  # If you need to temporarily deploy from a feature branch, you can set envs/rings here,
  # or use workflow_dispatch directly
  OVERRIDE_STUDIO_ENVIRONMENTS: ""
  OVERRIDE_RUNTIME_RINGS: ""

jobs:
  get-short-sha:
    uses: ./.github/workflows/template-short-sha.yaml

  docker-build-push:
    needs: get-short-sha
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Docker
        uses: docker/setup-docker-action@efe9e3891a4f7307e689f2100b33a155b900a608 # v4.5.0
        with:
          daemon-config: |
            {
              "features": {
                "containerd-snapshotter": true
              }
            }

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build docker image
        run: |
          SHA="${{ needs.get-short-sha.outputs.short-sha }}"
          IMAGE_BASE="ghcr.io/altinn/altinn-studio/kubernetes-wrapper"
          docker build --platform linux/amd64,linux/arm64 src/Runtime/kubernetes-wrapper \
            -f src/Runtime/kubernetes-wrapper/src/Dockerfile \
            -t "${IMAGE_BASE}:${SHA}"

      - name: Push docker image
        run: |
          SHA="${{ needs.get-short-sha.outputs.short-sha }}"
          IMAGE_BASE="ghcr.io/altinn/altinn-studio/kubernetes-wrapper"
          docker push "${IMAGE_BASE}:${SHA}"

  push-config-artifact:
    name: Push kubernetes-wrapper config artifact
    needs:
      - get-short-sha
      - docker-build-push
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write
    outputs:
      config-repo: ${{ steps.vars.outputs.config-repo }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set vars
        id: vars
        run: |
          SHA="${{ needs.get-short-sha.outputs.short-sha }}"
          echo "config-repo=ghcr.io/altinn/altinn-studio/kubernetes-wrapper-repo:${SHA}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@8454b02a32e48d775b9f563cb51fdcb1787b5b93 # v2.7.5

      - name: Patch base with image tag
        working-directory: src/Runtime/kubernetes-wrapper/infra/kustomize
        run: |
          export GHCR_IMAGE="ghcr.io/altinn/altinn-studio/kubernetes-wrapper:${{ needs.get-short-sha.outputs.short-sha }}"
          export RUNTIME_IMAGE="altinncr.azurecr.io/ghcr.io/altinn/altinn-studio/kubernetes-wrapper:${{ needs.get-short-sha.outputs.short-sha }}"
          export IMAGE_TAG="${{ needs.get-short-sha.outputs.short-sha }}"
          yq -i '.metadata.annotations["altinn.studio/image"] = env(GHCR_IMAGE)' base/deployment.yaml
          yq -i '.metadata.annotations["altinn.studio/image-tag"] = env(IMAGE_TAG)' base/deployment.yaml
          yq -i '.metadata.annotations["altinn.studio/image"] = env(RUNTIME_IMAGE)' runtime/overlay/image-annotation-patch.yaml
          yq -i '.metadata.annotations["altinn.studio/image-tag"] = env(IMAGE_TAG)' runtime/overlay/image-annotation-patch.yaml

      - name: Push config artifact
        working-directory: src/Runtime/kubernetes-wrapper/infra/kustomize
        run: |
          flux push artifact oci://${{ steps.vars.outputs.config-repo }} \
            --provider=generic \
            --reproducible \
            --path="." \
            --source="$(git config --get remote.origin.url)" \
            --revision="$(git branch --show-current)/$(git rev-parse HEAD)"

  construct-studio-environments-array:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.construct.outputs.result }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          sparse-checkout: |
            .github/scripts

      - name: Construct studio environments
        id: construct
        env:
          STUDIO_ENVIRONMENTS: ${{ github.event.inputs.studio-environments || '' }}
          INPUTS_JSON: ${{ toJSON(github.event.inputs) || 'null' }}
        run: |
          result="$(node .github/scripts/construct-environments.mjs \
            --mode studio \
            --value "$STUDIO_ENVIRONMENTS" \
            --inputs-json "$INPUTS_JSON" \
            --allow-empty 'true')"
          echo "result=$result" >> "$GITHUB_OUTPUT"

  construct-runtime-environments-array:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.construct.outputs.result }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          sparse-checkout: |
            .github/scripts

      - name: Construct runtime environments
        id: construct
        env:
          RUNTIME_RINGS: ${{ github.event.inputs.runtime-rings || '' }}
          INPUTS_JSON: ${{ toJSON(github.event.inputs) || 'null' }}
        run: |
          result="$(node .github/scripts/construct-environments.mjs \
            --mode runtime \
            --value "$RUNTIME_RINGS" \
            --inputs-json "$INPUTS_JSON" \
            --allow-empty 'true')"
          echo "result=$result" >> "$GITHUB_OUTPUT"

  tag-studio-artifacts:
    needs:
      - push-config-artifact
      - construct-studio-environments-array
    if: ${{ fromJSON(needs.construct-studio-environments-array.outputs.result)[0] != null }}
    strategy:
      matrix:
        include: ${{ fromJSON(needs.construct-studio-environments-array.outputs.result) }}
    runs-on: ubuntu-latest
    environment: ${{ matrix.environment }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@8454b02a32e48d775b9f563cb51fdcb1787b5b93 # v2.7.5

      - name: Tag config artifact for studio environment
        run: |
          flux tag artifact oci://${{ needs.push-config-artifact.outputs.config-repo }} \
            --tag "${{ matrix.environment }}"

  tag-runtime-artifacts:
    needs:
      - push-config-artifact
      - construct-runtime-environments-array
    if: ${{ fromJSON(needs.construct-runtime-environments-array.outputs.result)[0] != null }}
    strategy:
      matrix:
        include: ${{ fromJSON(needs.construct-runtime-environments-array.outputs.result) }}
    runs-on: ubuntu-latest
    environment: ${{ matrix.environment }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@8454b02a32e48d775b9f563cb51fdcb1787b5b93 # v2.7.5

      - name: Tag config artifact for runtime ring
        run: |
          flux tag artifact oci://${{ needs.push-config-artifact.outputs.config-repo }} \
            --tag "${{ matrix.ring }}"
