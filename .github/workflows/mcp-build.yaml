name: MCP - Build

on:
  pull_request:
    paths:
      - 'src/AI/mcp/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: '3.12'

    - name: Install uv
      run: pip install uv

    - name: Install dependencies
      working-directory: src/AI/mcp
      run: uv pip install --system .

    - name: Start MCP server
      working-directory: src/AI/mcp
      run: |
        uv run -m server.main > server.log 2>&1 &
        timeout 60 bash -c 'until grep -q "Initializing documentation search" server.log; do sleep 1; done'
      env:
        AZURE_API_KEY: ${{ secrets.AZURE_AI_KEY }}

    - name: Verify documentation indexing completes
      working-directory: src/AI/mcp
      run: timeout 180 bash -c 'until grep -q "Application startup complete" server.log; do sleep 1; done'

    - name: Output server logs on failure
      if: failure()
      working-directory: src/AI/mcp
      run: cat server.log