FROM --platform=$BUILDPLATFORM golang:1.26.0-trixie@sha256:889885d7cc1275935e3f9920aabadc5fadbe873f633d92a746f1bc401dd40f69 AS builder
ARG TARGETOS
ARG TARGETARCH

WORKDIR /app

COPY go.mod go.sum ./

# Remove the devenv dependency from go.mod as it's not needed for building binaries
# The test/harness package is only imported by test files, not by cmd/worker.
RUN sed -i '/altinn\.studio\/devenv v/d' go.mod && \
    sed -i '/replace altinn\.studio\/devenv/d' go.mod

RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -a -installsuffix cgo -o main ./cmd/worker

FROM docker.io/chromedp/headless-shell:stable@sha256:363bd3d5aa239b83def2ea036f34ac72543b1cba2316dceeafcba2b4d135da81

USER root

ENV DEBIAN_FRONTEND=noninteractive
RUN echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections && \
    sed -i 's/main$/main contrib/' /etc/apt/sources.list.d/debian.sources && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        fontconfig \
        ttf-mscorefonts-installer && \
    fc-cache -f -v && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=builder /app/main .

RUN mkdir -p ./output

EXPOSE 5031

RUN mkdir -p /tmp/user-home && \
    chown -R nobody:nogroup /tmp/user-home

ENV HOME=/tmp/user-home
USER nobody

ENTRYPOINT ["./main"]
